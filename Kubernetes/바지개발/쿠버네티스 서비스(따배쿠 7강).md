# 7ê°• ì¿ ë²„ë„¤í‹°ìŠ¤ ì„œë¹„ìŠ¤

## ì„œë¹„ìŠ¤(API) ê°œë…

-  ë™ì¼í•œ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” podê·¸ë£¹ì˜ ë‹¨ì¼ì§„ì…ì (virtual IP)ì„ ì œê³µ
-  ì„œë¹„ìŠ¤ëŠ” ì§€ì •ëœ IPë¡œ ìƒì„± ê°€ëŠ¥
-  ì—¬ëŸ¬ podë¥¼ ë¬¶ì–´ì„œ ë¡œë“œë°¸ëŸ°ì‹±ì´ ê°€ëŠ¥
-  ê³ ìœ í•œ DNSë¥¼ ê°€ì§ˆ ìˆ˜ ìˆê²Œ í•¨
-  ë¼ë²¨ ì…€ë ‰í„°(label selector)ë¥¼ ì´ìš©í•´ ê´€ë¦¬í•˜ê³ ì í•˜ëŠ” podë“¤ì„ ì •ì˜í•  ìˆ˜ ìˆìŒ

## deploymentì™€ Service ë¹„êµ

###  deployment
   -   nginx ì»¨í…Œì´ë„ˆì— labelì¸ app: webuiì„ ë¶™ì—¬ 3ê°œë¥¼ ìš´ì˜

```bash
#deploy-nginx.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webui
spec:
  replicas: 3
  selector:
    matchLabels:
      app: webui
  template:
    metadata:
      name: nginx-pod
      labels:
        app: webui
    spec:
      containers:
      - name: nginx-container
        image: nginx:1.14

```

### service
   -   kubectl createë¡œ ìƒì„±í•˜ë©´ ì‹¤ì œ í´ëŸ¬ìŠ¤í„° ipê°€ ìƒì„±ë¼ ë¡œë“œë°¸ëŸ¬ì„œ ê¸°ëŠ¥ì„ ì œê³µ

```bash
apiVersion: v1
kind: Service
metadata:
  name: webui-svc
spec:
  clusterIP: 10.96.100.100
  selector:
    app:webui
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80

```

## ì„œë¹„ìŠ¤ íƒ€ì…

### ClusterIP

-   label selectorë¥¼ ì´ìš©í•´ ë™ì¼í•œ label íŒŒë“œì˜ ê·¸ë£¹ìœ¼ë¡œ ë‹¨ì¼ ì§„ì…ì  (virtual ip)ì„ ìƒì„±
-   í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê³ , ì™¸ë¶€ IPë¥¼ í• ë‹¹í•˜ì§€ ëª»í•´ ì ‘ê·¼ì´ ë¶ˆê°€ëŠ¥í•¨
-   type ìƒëµ ì‹œ default ê°’ìœ¼ë¡œ 10.96.0.0/12 ë²”ìœ„ì—ì„œ í• ë‹¹ë¨

#### ì‹¤ìŠµ

-   ë””í”Œë¡œì´ë¨¼íŠ¸ë¥¼ ë¨¼ì € ìƒì„±í•˜ê³ , ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•´ ë‹¨ì¼ì§„ì…ì (cluster ip) ë§Œë“¤ì–´ ì¤Œ
    
    -   deploy-nginx.yaml
    
    ```bash
    #cat deploy-nginx.yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: webui
    spec:
      replicas: 3
      selector:
        matchLabels:
          app: webui
      template:
        metadata:
          name: nginx-pod
          labels:
            app: webui
        spec:
          containers:
          - name: nginx-container
            image: nginx:1.14
    
    ```
    
    -   kubectl createë¡œ ì»¨í…Œì´ë„ˆ 3ê°œ êµ¬í˜„
    
    ```bash
    # kubectl create -f deploy-nginx.yaml
    deployment.apps/webui created
    
    # kubectl get pods -o wide
    NAME                     READY   STATUS    RESTARTS   AGE   IP          NODE                NOMINATED NODE   READINESS GATES
    webui-6d4c4cc4b8-5nf72   1/1     Running   0          24s   10.44.0.1   node1.example.com   <none>           <none>
    webui-6d4c4cc4b8-7wgvt   1/1     Running   0          24s   10.36.0.1   node3.example.com   <none>           <none>
    webui-6d4c4cc4b8-gngbx   1/1     Running   0          24s   10.45.0.0   node2.example.com   <none>           <none>
    
    ```
    
    -   clusterip-nginx.yaml
    
    ```bash
    #cat clusterip-nginx.yaml
    apiVersion: v1
    kind: Service
    metadata:
      name: webui-svc
    spec:
      clusterIP: 10.100.100.100
      selector:
        app:webui
      ports:
      - protocol: TCP
        port: 80
        targetPort: 80
    
    ```
    
    -   í´ëŸ¬ìŠ¤í„° ip ìƒì„±
    
    ```bash
    # kubectl create -f clusterip-nginx.yaml
    service/clusterip-service created
    
    # kubectl get svc -o wide
    NAME                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE   SELECTOR
    clusterip-service   ClusterIP   10.100.100.100   <none>        80/TCP    6s    app=webui
    kubernetes          ClusterIP   10.96.0.1        <none>        443/TCP   18d   <none>
    
    # kubectl describe svc clusterip-service
    Name:              clusterip-service
    Namespace:         default
    Labels:            <none>
    Annotations:       <none>
    Selector:          app=webui
    Type:              ClusterIP
    IP Family Policy:  SingleStack
    IP Families:       IPv4
    IP:                10.100.100.100
    IPs:               10.100.100.100
    Port:              <unset>  80/TCP
    TargetPort:        80/TCP
    Endpoints:         10.36.0.1:80,10.44.0.1:80,10.45.0.0:80
    Session Affinity:  None
    Events:            <none>
    
    ```
    
-   ë™ì‘ í™•ì¸
    

```bash
# curl 10.100.100.100
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="<http://nginx.org/>">nginx.org</a>.<br/>
Commercial support is available at
<a href="<http://nginx.com/>">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>

```

-   ì‚­ì œ

```bash
# kubectl delete svc clusterip-service
service "clusterip-service" deleted

```

### NodePort

-   í´ëŸ¬ìŠ¤í„° IPë¿ë§Œ ì•„ë‹ˆë¼ ëª¨ë“  ë…¸ë“œì˜ IPì™€ í¬íŠ¸ë¥¼ í†µí•´ì„œë„ ì ‘ê·¼ì´ ê°€ëŠ¥
-   ëª¨ë“  ë…¸ë“œë¥¼ ëŒ€ìƒìœ¼ë¡œ ì™¸ë¶€ ì ‘ì† ê°€ëŠ¥í•œ í¬íŠ¸ë¥¼ ì˜ˆì•½
-   Default NodePort ë²”ìœ„: 30000-32767, ClusterIPë¥¼ ìƒì„± í›„ NodePort ì˜ˆì•½

![Untitled](https://user-images.githubusercontent.com/90545926/162612721-d308f240-6ba8-4597-99f2-00116883ae9d.png)

#### ì‹¤ìŠµ

-   ë””í”Œë¡œì´ë¨¼íŠ¸ë¥¼ ë¨¼ì € ìƒì„±í•˜ê³ , ì„œë¹„ìŠ¤ ìƒì„±

```bash
# kubectl create -f deploy-nginx.yaml
deployment.apps/webui created

# cat nodeport-nginx.yaml
apiVersion: v1
kind: Service
metadata:
  name: nodeport-service
spec:
  type: NodePort
  clusterIP: 10.100.100.200
  selector:
    app:  webui
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
    nodePort: 30200

# kubectl create -f nodeport-nginx.yaml
service/nodeport-service created

```

-   ë…¸ë“œí¬íŠ¸(30200)ê°€ ì—´ë ¤ ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŒ

```bash
# kubectl get svc -o wide
NAME               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE   SELECTOR
kubernetes         ClusterIP   10.96.0.1        <none>        443/TCP        18d   <none>
nodeport-service   NodePort    10.100.100.200   <none>        80:30200/TCP   20s   app=webui


```

-   ì›Œì»¤ë…¸ë“œ 1ì— ë“¤ì–´ê°€ì„œ 30200 í¬íŠ¸ê°€ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸í•´ ë³¼ ìˆ˜ ìˆìŒ

```bash
# netstat -napt | grep 30200
tcp        0      0 0.0.0.0:30200           0.0.0.0:*               LISTEN      14123/kube-proxy

```

### LoadBalancer
-   Public í´ë¼ìš°ë“œ (AWS, Azure, GCP ë“±)ì—ì„œ ìš´ì˜ê°€ëŠ¥
-   í´ë¼ìš°ë“œ ë²¤ë”ì—ì„œ ì œê³µí•˜ëŠ” ì„¤ì • ë°©ì‹ìœ¼ë¡œ, ì™¸ë¶€IPë¥¼ ê°€ì§€ê³  ìˆëŠ” ë¡œë“œë°¸ëŸ°ì„œë¥¼ í• ë‹¹
-   NodePortë¥¼ ì˜ˆì•½ í›„ í•´ë‹¹ nodeportë¡œ ì™¸ë¶€ ì ‘ê·¼ì„ í—ˆìš©

#### LoadBalancer Service
```bash
apiVersion: v1
kind: Service
metadata:
  name: loadbalancer-service
spec:
  type: LoadBalancer
  selector:
    app:webui
  ports:
  - protocol: TCP
    port: 80 
    targetPort: 80 

```

### ExternalName

-   í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œ External(ì™¸ë¶€)ì˜ ë„ë©”ì¸ì„ ì„¤ì •

#### ì‹¤ìŠµ

-   ë””í”Œë¡œì´ë¨¼íŠ¸ë¥¼ ë¨¼ì € ìƒì„±í•˜ê³ , ì„œë¹„ìŠ¤ ìƒì„±

```bash
# cat > external-name.yaml
apiVersion: v1
kind: Service
metadata:
  name: externalname-svc
spec:
  type: ExternalName
  externalName: google.com

# kubectl create -f external-name.yaml
service/externalname-svc created

# kubectl get svc -o wide
NAME               TYPE           CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE   SELECTOR
externalname-svc   ExternalName   <none>       google.com    <none>    4s    <none>
kubernetes         ClusterIP      10.96.0.1    <none>        443/TCP   18d   <none>

```

-   podë¥¼ ìƒì„±í•˜ê³  íŒŒë“œ ì•ˆìœ¼ë¡œ ì§„ì…í•˜ì—¬ curlë¡œ service ì´ë¦„ì„ í˜¸ì¶œ

```bash
# kubectl run testpod -it --image=centos:7
If you dont see a command prompt, try pressing enter.

[root@testpod /]# curl externalname-svc.default.svc.cluster.local
<!DOCTYPE html>
<html lang=en>
  <meta charset=utf-8>
  <meta name=viewport content="initial-scale=1, minimum-scale=1, width=device-width">
  <title>Error 404 (Not Found)!!1</title>
  <style>
    *{margin:0;padding:0}html,code{font:15px/22px arial,sans-serif}html{background:#fff;color:#222;padding:15px}body{margin:7% auto 0;max-width:390px;min-height:180px;padding:30px 0 15px}* > body{background:url(//www.google.com/images/errors/robot.png) 100% 5px no-repeat;padding-right:205px}p{margin:11px 0 22px;overflow:hidden}ins{color:#777;text-decoration:none}a img{border:0}@media screen and (max-width:772px){body{background:none;margin-top:0;max-width:none;padding-right:0}}#logo{background:url(//www.google.com/images/branding/googlelogo/1x/googlelogo_color_150x54dp.png) no-repeat;margin-left:-5px}@media only screen and (min-resolution:192dpi){#logo{background:url(//www.google.com/images/branding/googlelogo/2x/googlelogo_color_150x54dp.png) no-repeat 0% 0%/100% 100%;-moz-border-image:url(//www.google.com/images/branding/googlelogo/2x/googlelogo_color_150x54dp.png) 0}}@media only screen and (-webkit-min-device-pixel-ratio:2){#logo{background:url(//www.google.com/images/branding/googlelogo/2x/googlelogo_color_150x54dp.png) no-repeat;-webkit-background-size:100% 100%}}#logo{display:inline-block;height:54px;width:150px}
  </style>
  <a href=//www.google.com/><span id=logo aria-label=Google></span></a>
  <p><b>404.</b> <ins>Thatâ€™s an error.</ins>
  <p>The requested URL <code>/</code> was not found on this server.  <ins>Thatâ€™s all we know.</ins>

```

### í—¤ë“œë¦¬ìŠ¤ ì„œë¹„ìŠ¤

-   clusterIPê°€ ì—†ëŠ” ì„œë¹„ìŠ¤ë¡œ ë‹¨ì¼ì§„ì…ì ì´ í•„ìš” ì—†ì„ ë•Œ ì‚¬ìš©
-   Serviceì™€ ì—°ê²°ëœ Podì˜ endpointë¡œ DNS ë ˆì½”ë“œê°€ ìƒì„±ë¨
-   podì˜ DNS ì£¼ì†Œ : pod-ip-addr.namespace.pod.cluster.local
-   typeì´ ì•„ë‹ˆë¼ ClusterIPê°€ Noneì¸ ê²½ìš°
-   ë³„ë„ì˜ IP ë‹¨ì¼ì§„ì…ì ì´ ì—†ì§€ë§Œ endpointë“¤ì˜ DNS ë ˆì½”ë“œë“¤ì„ ì¿ ë²„ë„¤í‹°ìŠ¤ê°€ ê°€ì§€ê³  ìˆëŠ” coreDNSì— ë“±ë¡ â†’ íŒŒë“œì— ëŒ€í•œ endpointë¥¼ DNS ë¦¬ì¡¸ë¹™ ì„œë¹„ìŠ¤ë¡œ ìš”ì²­í•  ìˆ˜ ìˆìŒ. ì¦‰ íŒŒë“œê°€ DNS ë¦¬ì¡¸ë¹™ ì„œë¹„ìŠ¤ë¥¼ ë°›ì„ ìˆ˜ ìˆê²Œ ì§€ì›

#### ì‹¤ìŠµ

-   ë””í”Œë¡œì´ë¨¼íŠ¸ë¥¼ ë¨¼ì € ìƒì„±í•˜ê³  ì„œë¹„ìŠ¤ë¥¼ ìƒì„±
    
    -   ë””í”Œë¡œì´ë¨¼íŠ¸ ìƒì„±
    
    ```bash
    # cat deploy-nginx.yaml 
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: webui
    spec:
      replicas: 3
      selector:
        matchLabels:
          app: webui
      template:
        metadata:
          name: nginx-pod
          labels:
            app: webui
        spec:
          containers:
          - name: nginx-container
            image: nginx:1.14
    		
    # kubectl create -f deploy-nginx.yaml 
    deployment.apps/webui create
    
    ```
    
    -   cluster ipë¥¼ noneìœ¼ë¡œ ì„¤ì •í•˜ë©´ headless service
    
    ```bash
    # cat headless-service.yaml
    apiVersion: v1
    kind: Service
    metadata:
      name: headless-service
    spec:
      type: ClusterIP
      clusterIP: None
      selector:
        app: webui
      ports:
      - protocol: TCP
        port: 80
        targetPort: 80
    
    ```
    
    -   ì„œë¹„ìŠ¤ ìƒì„±
    
    ```bash
    # kubectl create -f headless-service.yaml 
    service/headless-service created
    
    # kubectl get svc -o wide
    NAME               TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE    SELECTOR
    headless-service   ClusterIP   None         <none>        80/TCP    9s     app=webui
    kubernetes         ClusterIP   10.96.0.1    <none>        443/TCP   117m   <none>
    
    ```
    
    -   ì„œë¹„ìŠ¤ ìƒì„¸ì •ë³´ í™•ì¸
    
    ```bash
    # kubectl describe svc headless-service 
    Name:              headless-service
    Namespace:         default
    Labels:            <none>
    Annotations:       <none>
    Selector:          app=webui
    Type:              ClusterIP
    IP Family Policy:  SingleStack
    IP Families:       IPv4
    IP:                None
    IPs:               None
    Port:              <unset>  80/TCP
    TargetPort:        80/TCP
    Endpoints:         10.36.0.1:80,10.44.0.1:80,10.44.0.2:80
    Session Affinity:  None
    Events:            <none>
    
    ```
    
-   podë¥¼ ìƒì„±í•˜ê³  íŒŒë“œ ì•ˆìœ¼ë¡œ ì§„ì…í•˜ì—¬ dnsì„œë²„ í™•ì¸
    

```bash
# kubectl run testpod -it --image=centos:7 /bin/bash
If you dont see a command prompt, try pressing enter.

[root@testpod /]# cat /etc/resolv.conf 
nameserver 10.96.0.10
search default.svc.cluster.local svc.cluster.local cluster.local
options ndots:5


```

-   curl ëª…ë ¹ì–´ë¡œ DNSë ˆì½”ë“œ(ë„ë©”ì¸)ì— ë¦¬ì¡¸ë¹™ì„ í•˜ê²Œ ë˜ë©´ coreDNSê°€ ì—°ê²°í•´ì¤Œ

```bash
[root@testpod /]# curl 10-36-0-1.default.pod.cluster.local
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="<http://nginx.org/>">nginx.org</a>.<br/>
Commercial support is available at
<a href="<http://nginx.com/>">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>

```

## kube-proxy

- Kubernetes Serviceì˜ êµ¬í˜„í•˜ëŠ” backend ì‹œìŠ¤í…œ
- endpoint ì—°ê²°ì„ ìœ„í•œ iptables êµ¬ì„±
- nodePortë¡œì˜ ì ‘ê·¼ê³¼ Pod ì—°ê²°ì„ êµ¬í˜„


### userspace

-   í´ë¼ì´ì–¸íŠ¸ì˜ ì„œë¹„ìŠ¤ ìš”ì²­ì„ iptablesë¥¼ ê±°ì³ kube-proxyê°€ ë°›ì•„ì„œ ì—°ê²°
-   kubernetes ì´ˆê¸°ë²„ì „ì— ì ê¹ ì‚¬ìš©(ì§€ê¸ˆì€ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ)

<aside> ğŸ’¡ ì‹¤ì œ ë…¸ë“œ í¬íŠ¸ì—ì„œ iptables ë£°ì´ ë¨¼ì € ì ìš©ë˜ê³  kube-proxyê°€ ë°›ì•„ì„œ íŒŒë“œì™€ ì—°ê²°ì‹œì¼œì¤Œ

</aside>

### iptables

-   default kubernetes network mode
-   kube-proxyëŠ” service API ìš”ì²­ì‹œ ë°›ì•„ì„œ iptables ë£°ì´ ìƒì„±
-   í´ë¼ì´ì–¸íŠ¸ ì—°ê²°ì€ kube-proxyê°€ ë°›ì•„ì„œ iptables ë£°ì„ í†µí•´ ì—°ê²°

### IPVS

-   ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì´ ì§€ì›í•˜ëŠ” L4 ë¡œë“œë°¸ëŸ°ì‹± ê¸°ìˆ ì„ ì´ìš©
-   ë³„ë„ì˜ ipvs ì§€ì› ëª¨ë“ˆì„ ì„¤ì •í•œ í›„ ì ìš©ê°€ëŠ¥
-   ì§€ì› ì•Œê³ ë¦¬ì¦˜: rr(round-robin), lc(least connection), dh(destination hashing), sh(source hashing), sed(shortest expected delay), nq(never queue)
