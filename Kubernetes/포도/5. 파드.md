# 파드
## Pod의 개념 및 사용하기
+ 컨테이너를 표현하는 k8s API의 최소 단위
+ Pod에는 하나 또는 여러 개의 컨테이너가 포함될 수 있음  
<br>

## Pod 동작 flow
1. 쿠버네티스에 명령을 내리면 API가 해당 명령이 제대로된 문법인지 확인한다.
2. etcd에서 정보를 받아와 Scheduler에 넘긴다.
3. Scheduler는 웹서버 Pod를 어디에 실행하면 가장 좋을지 선택한다.
1. 하나의 Pod는 어디로 배치될지 스케줄링 받을 때까지는 Pending 상태로 표시한다.  
2. 스케줄링을 받은 후에는 Running 상태가 된다.
3. 성공/실패하는 경우 Succeeded/Failed로 표시한다.  
<br>

## Pod 생명주기 
+ Pending : 쿠버네티스 시스템에 파드를 생성하는 중임을 뜻하며, 이 상태는 컨테이너 이미지를 다운로드한 후 전체 컨테이너를 실행하는 도중이므로 파드 안의 전체 컨테이너가 실행될 때까지 시간이 걸린다.
+ Running : 파드 안 모든 컨테이너가 실행 중인 상태를 말한다.
+ Succeeded : 파드 안 모든 컨테이너가 정상 실행 종료된 상태로 재시작되지 않는 상태이다.
+ Failed : 파드 안 컨테이너 중 정상적으로 실행 종료되지 않은 컨테이너가 있는 상태이다. (컨테이너 종료 코드가 0이 아니면 비정상 종료이거나 시스템이 직접 컨테이너를 종료한 것)
+ Unknown : 파드의 상태를 확인할 수 없는 경우로 보통 파드가 있는 노드와 통신할 수 없을 때를 의미한다.  
<br>

## 동작 중인 Pod 확인
```bash
$ kubectl delete pod --all
$ kubectl get pods -o wide --watch
```
너무 많은 Pod 정보가 나오면 상태를 보기가 어렵기 때문에 delete를 이용하여 먼저 삭제해 준다.
--watch를 사용하면 line by line으로 현재 상태를 표시해 준다.
<br>

## Pod 관리하기
+ 동작 중인 파드 정보 보기
  ```bash
  $ kubectl get pods
  $ kubectl get pods -o wide
  $ kubectl describe pod webserver
  ```
+ 동작 중인 파드 수정
  ```bash
  $ kubectl edit pod webserver
  ```
+ 동작 중인 파드 삭제
  ```bash
  $ kubectl delete pod webserver
  $ kubectl delete pod --all
  ```
+ 전체 namespace에서 동작 중인 파드 모두 확인
  ```bash
  $ kubectl get pods --all-namespaces
  ```
  --all-namespaces를 빼면 default namespace의 파드들만 확인 가능하다.

## Liveness Probe를 이용한 self-healing Pod
Self-healing : 컨테이너가 제대로 동작되지 않을 때 재시작해주는 기능이다. (건강한 컨테이너만 가지고 애플리케이션 서비스를 지원하는 것을 보장)  
3번 연속 연결에 실패하면 건강하지 않은 컨테이너로 판단한다. 건강하지 않은 컨테이너는 죽이고, 허브에서 다시 건강한 컨테이너를 받아와 실행한다.
  
### Liveness Probe
self-healing 기능이 포함되게 하려면 컨테이너에 livenessProbe를 배치시켜야 한다.  
![Liveness Probe](https://user-images.githubusercontent.com/77559262/158566423-11432a43-11d7-44a6-a767-1da27d2979ca.png)
```bash
livenessProbe:
  httpGet:   # 웹 기반의 서비스이기 때문에 httpGet으로 제대로 일하고 있는지 확인
    path: /  # path는 루트
    port: 80 # 웹서비스의 80 포트로 접속 → 응답이 나오면 건강한 포트라고 판단
```
<br>

### Liveness Probe 매커니즘
애플리케이션 컨테이너의 특성에 따라 검진하는 방식을 나누어 놓은 것
+ __httpGet__ probe : 웹 Probe 지원 방법으로 지정한 IP주소, port, path에 HTTP GET 요청을 보내 해당 컨테이너가 응답하는지를 확인한다. 반환 코드가 200이 아닌 값이 나오면 오류로 판단하고, 컨테이너를 다시 시작한다.
  ```bash
  livenessProbe:
    httpGet:  
      path: /  
      port: 80 
  ```
+ __tcpSocket__ probe : 지정된 포트에 TCP 연결을 시도하고, 연결되지 않으면 컨테이너를 다시 시작한다.
  ```bash
  livenessProbe:
    tcpSocket:   
      port: 22 
  ```
+ __exec__ probe : exec 명령을 전달하고 명령의 종료코드가 0이 아니면 컨테이너를 다시 시작한다.
  ```bash
  livenessProbe:
    exec:  
      command:   
      - ls
      - /data/file 
  ```
### Liveness Probe 매개변수
+ periodSeconds : health check 반복 실행 시간(초)
+ initialDelaySeconds : Pod 실행 후 delay할 시간(초)
+ timeoutSeconds : health check 후 응답을 기다리는 시간(초)  

아래 명령어를 입력하여 모든 매개변수 확인 가능 (현재 실행 중인 파드를 yaml 파일로 내용을 보겠다)
```bash
$ kubectl get pod nginx-pod-liveness -o yaml
```
<br>

## init container를 적용한 Pod
init container : main container를 적용하는데 필요한 환경 세팅, 초기화 구성 등을 지원해주는 컨테이너로 init container가 성공해야만 main container가 실행된다.  
 + 앱 컨테이너 실행 전에 미리 동작시킬 컨테이너
 + 본 Container가 실행되기 전에 사전 작업이 필요할 경우 사용
 + 초기화 컨테이너가 모두 실행된 후에 앱 컨테이너를 실행  
<br>

## infra container(pause)
infra container : pod를 만들면 자동으로 만들어지고, pod가 삭제되면 같이 삭제되는 컨테이너이다. pod마다 1개가 생성된다. pod에 대한 infra(id, hostname 등)를 관리, 생성하는 역할을 한다.