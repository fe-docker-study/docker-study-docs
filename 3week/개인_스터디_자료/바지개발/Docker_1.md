# Docker

# Docker?

리눅스 컨테이너에 여러 기능을 추가함으로써 애플리케이션 컨테이너로서 좀 더 쉽게 사용할 수 있게 만들어진 오픈소스 프로젝트

기존에 쓰이던 가상화 방법인 가상머신과는 달리 도커 컨테이너는 성능의 손실이 거의 없는 차세대 클라우드 인프라 솔루션

[가상머신과 도커 차이](https://www.notion.so/16f70692c4d44abcbd625d87f53cb4ff)

# **장점**

- 애플리케이션의 개발과 배포가 편함
- 컨테이너 내부에서 수많은 소프트웨어를 설치하고 설정파일을 수정해도 호스트 OS에 영향X
- 각종 라이브러리 설치 등으로 인한 의존성 걱정없이 개발환경을 운영서버에 컨테이너로 똑같이 복제 가능
- 여러 애플리케이션의 독립성과 확장성이 높아짐
- 여러 모듈을 독립된 형태로 구성하기 때문에 언어에 종속되지 않고 변화에 빠르게 대응, 각 모듈의 관리가 편함

# **도커** **이미지**

- 이미지는 컨테이너를 생성할 때 필요한 요소, 가상 머신을 생성할때 사용하는 iso 파일과 비슷한 개념
- 이미지는 여러 개의 계층으로 된 바이너리 파일로 존재
- 컨테이너를 생성하고 실행할 때 읽기 전용으로 사용
- 이미지는 도커 명령어로 내려받을 수 있음
- 운영체제부터 각종 애플리케이션 등 다양한 종류가 있음

도커에서 사용하는 이미지의 이름은 기본적으로의 아래의 형태

[저장소 이름]/[이미지 이름]:[태그]
ex) alicek106/ubuntu:14.04

- 저장소 : 이미지가 저장된 장소(저장소 이름이 명시되지 않은 이미지는 Docker Hub 공식 이미지)
- 이미지 이름 : 해당 이미지가 어떤 역할을 하는지 나타냄
- 태그 : 이미지의 버전 관리에 사용

# **도커** **컨테이너**

- 이미지로 컨테이너를 생성하면 해당 이미지의 목적에 맞는 파일이 들어 있는 파일시스템과 격리된 시스템 자원 및 네트워크를 사용할 수 있는 독립된 공간이 생성
- 컨테이너는 이미지를 읽기 전용으로 사용하며 이미지에서 변경된 사항만 컨테이너 계층에 저장
- 생성된 각 컨테이너는 각 독립된 파일시스템을 제공받고 호스트와 분리되어 있어 서로 영향을 주지 않음

# **도커** **명령어**

컨테이너를 대상으로 하는 모든 명령어는 컨테이너 이름 대신 ID를 쓸 수 있음

[도커 기본 명령어 모음](https://www.notion.so/678369f5c8204bcb834935d227b3927f)

# **컨테이너를** **외부에** **노출**

컨테이너는 가상머신과 마찬가지로 가상 IP 주소를 할당받음

추가적 설정을 통해 도커가 설치된 호스트 외에 외부에서 접근 할 수 있음

```tsx
# docker run -i -t --name mywebserver -p 80:80  unbuntu:14.04
```

-p [호스트 포트]:[컨테이너 포트]

-p옵션을 사용해 컨테이너의 포트를 호스트의 포트와 바인딩해 연결할 수 있게 설정

호스트의 특정 IP를 사용하려면 바인딩할 IP와 포트를 같이 명시

여러개의 포트를 외부에 개방하려면 -p옵션을 여러 번 사용

```tsx
# docker run -i -t -p 192.168.0.100:7777:80 -p 3306:3306  unbuntu:14.04
```

컨테이너 내부에 아파치 웹서버 설치를 하고 실행을 하면 [도커엔진 호스트 IP]:80으로 접근 가능

클라이언트 -> 호스트 IP의 80번 포트 -> 80번 컨테이너 포트로 포워딩 -> 웹서비스(80번 포트)

# **컨테이너** **애플리케이션** **구축**

한 컨테이너에 하나의 프로세스만

각 컨테이너 간의 독립성을 보장함과 동시에 애플리케이션의 버전관리, 소스코드 모듈화 등이 쉬워짐

```tsx
# docker run -d \
--name wordpressdb \
-e MYSQL_ROOT_PASSWORD=password \
-e MYSQL_ROOT_PASSWORD=wordpress \
mysql:5.7
```

mysql 데이터베이스 컨테이너 생성 및 실행

-i -t로 생성하면 하나의 터미널을 차지하는 mysqld프로그램이 포그라운드로 실행. MySQL이미지는 컨테이너가 실행될때 mysqld가 동작하도록 설정되어 있기 때문. 이 상태에서는 상호입출력이 불가능하고 단순히 프로그램이 포그라운드 모드로 동작하는 것만 지켜 봄. 그렇기 때문에 -d 옵션을 설정해 컨테이너가 백그라운드에서 동작하게 함

포그라운드로 실행되어 배시셸을 사용하지 못하지만 exec 명령어를 이용하면 컨테이너 내부 셸을 사용할 수 있음. -i -t 옵션으로 상호입력이 가능한 형태로 exec 결과값을 반환(옵션을 안쓰면 명령어의 결과 값만 반환)

```tsx
# docker exec -i -t wordpressdb /bin/bash
# echo $MYSQL_ROOT_PASSWORD
# mysql -u root -p
```

그러나 비밀번호처럼 민감한 정보를 컨테이너 내부의 환경변수로 설정하는 것은 바람직하지 않음. 이런 경우는 도커 스웜모드의 secret같은 기능을 활용해 안전하게 비밀번호를 전달하는 게 좋다.

```tsx
# docker run -d \
-e WORDPRESS_DB_PASSWORD=password \
--name wordpress \
-- link wordpressdb:mysql \
-p 80 \
wordpress
```

워드프레스 이미지를 이용해 워드프레스 웹서버 컨테이너를 생성

-p 옵션으로 호스트 포트 중 하나와 컨테이너의 80번 포트가 연결

docker ps 명령어로 호스트의 어느 포트와 연결됐는지 확인 가능

--link 옵션을 줌으로 컨테이너에 alias로 접근하도록 설정(컨테이너를 시작할때마다 재할당받는 내부IP로는 접근하기 힘들기 때문). 즉 워드프레스 웹서버 컨테이너는 wordpressdb의 IP를 몰라도 mysql이라는 호스트명으로 접근가능.

--link옵션을 쓰면 컨테이너를 연결해주는 것뿐만 아니라 컨테이너 실행순서의 의존성도 정의. 따라서 --link에 입력된 컨터이너가 실행 중이지 않거나 존재하지 않는다면 --link를 적용한 컨테이너 또한 실행할 수 없음. 현재 deprecated된 옵션이고 도커 브리지 네트워크를 사용하는 것을 권장

웹브라우저로 [호스트 IP]:[연결된 포트] 으로 접근해 확인